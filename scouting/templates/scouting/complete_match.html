{% extends 'base.html' %}

{% block title %}Complete Match {{ match.match_number }}{% endblock %}

{% block content %}
<div class="card">
    <h2>Complete Match {{ match.match_number }}</h2>
    <p>{{ match.event.name }} - {{ match.scheduled_time|date:"M d, Y H:i" }}</p>
    
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin: 1rem 0; padding: 1rem; background: #f5f5f5; border-radius: 4px;">
        <div>
            <strong style="color: #d32f2f;">Red Alliance:</strong><br>
            Team {{ match.red_1.team_number }}, {{ match.red_2.team_number }}, {{ match.red_3.team_number }}
        </div>
        <div>
            <strong style="color: #1976d2;">Blue Alliance:</strong><br>
            Team {{ match.blue_1.team_number }}, {{ match.blue_2.team_number }}, {{ match.blue_3.team_number }}
        </div>
    </div>
    
    {% if match.status == 'COMPLETED' %}
    <div style="background: #d4edda; padding: 1rem; border-radius: 4px; border-left: 4px solid #28a745; margin: 1rem 0;">
        <strong>✓ Match Already Completed</strong><br>
        Winner: <strong>{{ match.winner }} Alliance</strong><br>
        Score: {{ match.red_score }} - {{ match.blue_score }}
    </div>
    <a href="{% url 'view_match_reports' match.id %}" class="btn" style="background: #6c757d;">Back to Reports</a>
    {% else %}
    
    <form method="post">
        {% csrf_token %}
        
        <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; border-left: 4px solid #ffc107; margin: 1rem 0;">
            <strong>Important:</strong> Completing this match will:
            <ul style="margin: 0.5rem 0;">
                <li>Mark the match status as COMPLETED</li>
                <li>Verify all scouter predictions and award points for correct predictions</li>
                <li>Award bonus XP (5 points) to all scouters who submitted confirmed reports</li>
                <li>Lock the match data from further changes</li>
            </ul>
        </div>
        
        <h3>Enter Final Match Scores</h3>
        
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div class="form-group">
                <label for="red_score" style="color: #d32f2f; font-weight: bold;">Red Alliance Score</label>
                <input type="number" id="red_score" name="red_score" required min="0" 
                       value="{{ match.red_score|default:'' }}" 
                       style="font-size: 1.5rem; font-weight: bold;">
            </div>
            
            <div class="form-group">
                <label for="blue_score" style="color: #1976d2; font-weight: bold;">Blue Alliance Score</label>
                <input type="number" id="blue_score" name="blue_score" required min="0" 
                       value="{{ match.blue_score|default:'' }}" 
                       style="font-size: 1.5rem; font-weight: bold;">
            </div>
        </div>
        
        <button type="submit" class="btn btn-success">Complete Match & Verify Predictions</button>
        <a href="{% url 'view_match_reports' match.id %}" class="btn" style="background: #6c757d;">Cancel</a>
    </form>
    {% endif %}
</div>

<div class="card">
    <h2>Confirmed Reports ({{ reports.count }})</h2>
    {% if reports %}
    <table>
        <thead>
            <tr>
                <th>Scouter</th>
                <th>Team</th>
                <th>Rating</th>
                <th>Confirmed By</th>
            </tr>
        </thead>
        <tbody>
            {% for report in reports %}
            <tr>
                <td>{{ report.scouter.username }}</td>
                <td><strong>{{ report.team.team_number }}</strong></td>
                <td>{{ report.overall_rating }}/10</td>
                <td>{{ report.confirmed_by.username }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p style="color: green; margin-top: 1rem;">
        ✓ All {{ reports.count }} scouters will receive +5 bonus XP when match is completed
    </p>
    {% else %}
    <p style="color: orange;">⚠ No confirmed reports yet. Consider waiting for scouters to submit their data.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Predictions to Verify ({{ predictions.count }})</h2>
    {% if predictions %}
    <table>
        <thead>
            <tr>
                <th>Scouter</th>
                <th>Predicted Winner</th>
                <th>Current Status</th>
            </tr>
        </thead>
        <tbody>
            {% for prediction in predictions %}
            <tr>
                <td>{{ prediction.scouter.username }}</td>
                <td style="color: {% if prediction.predicted_winner == 'RED' %}#d32f2f{% else %}#1976d2{% endif %}; font-weight: bold;">
                    {{ prediction.predicted_winner }} Alliance
                </td>
                <td>
                    {% if prediction.is_correct is None %}
                    <span style="color: gray;">Awaiting verification</span>
                    {% elif prediction.is_correct %}
                    <span style="color: green;">✓ Correct (verified)</span>
                    {% else %}
                    <span style="color: red;">✗ Incorrect (verified)</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p style="color: blue; margin-top: 1rem;">
        ℹ Scouters with correct predictions will receive +1 prediction point
    </p>
    {% else %}
    <p>No predictions submitted for this match.</p>
    {% endif %}
</div>

{% endblock %}
